<!DOCTYPE html>
<html id="playground">
<head>
    <link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
    <meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Piano-projector</title>

    <!-- Midi.js package -->
    <script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->
    <script src="lib/MIDI.js-master/js/midi/audioDetect.js"></script>
    <script src="lib/MIDI.js-master/js/midi/gm.js"></script>
    <script src="lib/MIDI.js-master/js/midi/loader.js"></script>
    <script src="lib/MIDI.js-master/js/midi/player.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.audiotag.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webaudio.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webmidi.js"></script>
    <script src="lib/MIDI.js-master/js/midi/synesthesia.js"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/event.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/timer.js"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->

    <!-- Other external libraries -->
    
    <script src="lib/soundfontplayer.js"></script>
    <script src="lib/webmidi/src/webmidi.js"></script>
    <script src="lib\threex.dynamictexture.js"></script>
    <script src="lib\three.js-master\docs\build\three.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
    <script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/BloomPass.js"></script>
    <script src="lib/three.js-master/examples/js/shaders/ConvolutionShader.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/TexturePass.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/BloomBlendPass.js"></script>

    </script>
    <script src="lib\threex.dynamictexture.js"></script>
    <script src="lib/GPUParticleSystem.js"></script>
    <script src="lib\three.js-master\docs\build\three.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
    <script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>
    <script src = "lib/normaltextfont.js"></script>

            
    <!-- Internal js files -->
    <script src="getPositionX.js"></script>
    <script src="NoteBlock.js"></script>
    <script src="EventReader.js"></script>
    <script src="Song.js"></script>
    <script src="Clock.js"></script>
    <script src="parseSongData.js"></script>
    <script src="getSongArray.js"></script>
    <script src="ParticleSystem_KeyPressed.js"></script>   
    <script src="keyEffects.js"></script>
    <script src="PointGiver.js"></script>
    <script src="SongResizer.js"></script>
    <script src="Keyboard.js"></script>
    <script src="midi-player.js"></script>


</head>
<body>
<script>

    //Global variables
    var asd = -1;
    var asd2 = -1;
    var letsGo = -1;

// Declaring starting text variables
var loader = new THREE.FontLoader();
var group = new THREE.Group();
var textMesh, textMaterial;
    
    var SetupArray = getSetupInfo();

    var tick = 0;
    var clock = new THREE.Clock();

    var keyboard = new Keyboard();
    var song = new Song(location.search.substring(1).split("?")[3]);

        //Play picked song
    song.setVolume(0.4);
   // song.playSong();

    var jingleBells2  = new Song('jingleBells2');
    var jingleIntro = new Song('jingleIntro2');
    var jingleTest = new Song('jingleBellsNoIntro');

    jingleBells2.setVolume(0.4);
   // jingleIntro.playSong();
    var tempo = getSongTempo(location.search.substring(1).split("?")[3]);

    // Extracting line positions
 //   var rightLinePos = location.search.substring(1).split("?")[1];
 //   var leftLinePos = location.search.substring(1).split("?")[2];

    var rightLinePos = SetupArray[2];
    var leftLinePos = SetupArray[3];
    
    var errorSound = new Audio('./songs-mp3/error.wav');
    var noteBlockArray = [];
    var delBlockArray = [];
    var blockIndex = 0;
    var startTime;

    //Create the particle variables
    var particleCount = 500;
    var particleCount2 = 30;
    var particles = new THREE.Geometry();
    var particles2 = new THREE.Geometry();
    var pMaterial, pMaterial2;
    var pMaterial = new THREE.PointsMaterial({color: 0xFFFFFF, size: 1, map: THREE.ImageUtils.loadTexture("lib/three.js-master/examples/textures/lensflare/lensflare0.png"), blending: THREE.AdditiveBlending, transparent: true});
    var pMaterial2 = new THREE.PointsMaterial({color: 0xFFFFFF, size: 1, map: THREE.ImageUtils.loadTexture("lib/three.js-master/examples/textures/lensflare/lensflare0.png"), blending: THREE.AdditiveBlending, transparent: true});
    // create the particle system
    var particleSystem;
    var particleSystem2;
    var particleSystem_keyPressed = [];
        
    var meshGroup = new THREE.Object3D();

        //Creating scene
    var scene = new THREE.Scene();
    var renderer = new THREE.WebGLRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.setClearColor( 0x000000 );
    document.body.appendChild( renderer.domElement );
    renderer.shadowMapEnabled = true;

        //Create black line at bottom of scene
        var geometry = new THREE.BoxGeometry(rightLinePos-leftLinePos + 2, 0.2, 1);
        var material = new THREE.MeshPhongMaterial({ color: 0x9C9C9C, transparent: true, opacity: 0.2 });
        //var material2 = new THREE.MeshPhongMaterial({ color: 0xff0000, transparent: true, opacity: 0.2 });
        var line = new THREE.Mesh(geometry, material);
     //   scene.add(line);


    document.body.appendChild(renderer.domElement);

    // Creating 3D camera
    cameraLeft = new THREE.PerspectiveCamera( 75, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
    cameraLeft.position.set( 0, 0, 10 );
    scene.add(cameraLeft);
    cameraRight = new THREE.PerspectiveCamera( 75, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
    cameraRight.position.set( 0, 0, 10);
    scene.add(cameraRight);
    let width = Math.round(window.innerWidth / 2),
        height = window.innerHeight;


//PASSES
var renderPass1 = new THREE.RenderPass(scene, cameraLeft);
var renderPass2 = new THREE.RenderPass(scene, cameraRight);
var effectCopy = new THREE.ShaderPass(THREE.CopyShader);
//var bloomPass = new THREE.BloomBlendPass( 3.0, 1.5, new THREE.Vector2(512, 512));
var bloomPass = new THREE.BloomBlendPass( 1, 0.1, new THREE.Vector2(512, 512));
bloomPass.renderToScreen = true;

    //First composer
    var composer = new THREE.EffectComposer(renderer);
    composer.addPass(renderPass1);
    composer.addPass(renderPass2);
    composer.addPass(effectCopy);
    var renderScene = new THREE.TexturePass(composer.renderTarget2);

        //Second composer (BloomPass)
        var composer2 = new THREE.EffectComposer(renderer);
        composer2.addPass(renderScene);
        composer2.addPass(bloomPass);
        composer2.addPass(effectCopy);
        var theHeight = 2 * Math.tan( ( 75*Math.PI/180 / 2 ) ) * cameraLeft.position.z;
            var linegeometry = new THREE.Geometry();
            var linematerial = new THREE.LineBasicMaterial({ color: 0x0000ff });
            linegeometry.vertices.push(new THREE.Vector3(0, -10, 0));
            linegeometry.vertices.push(new THREE.Vector3(0, 10, 0));
            var theLine = new THREE.Line(linegeometry, linematerial);
            var theLine2 = new THREE.Line(linegeometry, linematerial);
            scene.add(theLine);
            scene.add(theLine2);

            theLine.position.x = rightLinePos;
            theLine2.position.x = leftLinePos;
            theLine.position.y = 0;
            theLine2.position.y = 0;
            

    //Creating lanes
    var l1  = new THREE.Line(linegeometry, linematerial);
    var l2  = new THREE.Line(linegeometry, linematerial);
    var l3  = new THREE.Line(linegeometry, linematerial);
    var l4  = new THREE.Line(linegeometry, linematerial);
    scene.add(l1);
    scene.add(l2);
    scene.add(l3);
    scene.add(l4);

    var right = location.search.substring(1).split("?")[1],
    left = location.search.substring(1).split("?")[2];

              if(left.includes('-'))
                {
                    left = -left.split("-").pop();
                }

    let pianoLength = right-left,

    noteWidth = pianoLength/SetupArray[0];

    l1.position.x = getPositionX('C2')-noteWidth/2;
    l2.position.x = getPositionX('C3')-noteWidth/2;
    l3.position.x = getPositionX('C4')-noteWidth/2;
    l4.position.x = getPositionX('C5')-noteWidth/2;

    //Creating scoreboard
    var dynamicTexture  = new THREEx.DynamicTexture(512,512*2);
    dynamicTexture.context.font	= "150px Verdana";
    var scoreGeo = new THREE.CubeGeometry(2, 1, 2);
    scoreGeo.side = THREE.DoubleSide;
    var scoreMat = new THREE.MeshPhongMaterial({ map : dynamicTexture.texture, specular: 10});
    scoreMat.side = THREE.DoubleSide;
    var side1 = new THREE.MeshPhongMaterial({ color: 0x0033ff, specular: 0x555555, shininess: 5});
    var side2 = new THREE.MeshPhongMaterial({ color: 0x0033ff});
    var side3 = new THREE.MeshPhongMaterial({ color: 0x0033ff});
    var side4 = new THREE.MeshPhongMaterial({ color: 0x0033ff }); // left
    var side5 = new THREE.MeshPhongMaterial({ color: 0x0033ff});
    var materials = [scoreMat, side1, side2, side3,  side4,  side5];
    materials.side = THREE.DoubleSide;
    var meshFaceMaterial = new THREE.MeshFaceMaterial( materials );
    meshFaceMaterial.side = THREE.DoubleSide;
    //  var scoreBoard = new THREE.Mesh(scoreGeo, scoreMat);
    var scoreBoard = new THREE.Mesh(scoreGeo, meshFaceMaterial);
    scoreBoard.side = THREE.DoubleSide;
    scoreBoard.position.set(-10,6,0);
    scoreBoard.rotation.x = 3*Math.PI/45;
    scoreBoard.rotation.y = -6*Math.PI/45;

    scene.add(scoreBoard);
    dynamicTexture.texture.needsUpdate = true;

    function init() {

        // The GPU Particle system extends THREE.Object3D, and so you can use it
        // as you would any other scene graph component.	Particle positions will be
        // relative to the position of the particle system, but you will probably only need one
        // system for your whole scene

        //Adding particle systems to the array particleSystem_keyPressed and to the scene
        //Mapping each particle system to the keys in the selected song

        let particleElement = 0;
        for(let i = 0; i < noteBlockArray.length; ++i)
        {
            //Don't adding duplicates. 
            if( particleSystem_keyPressed.map(x => x.note).indexOf(noteBlockArray[i].note) == -1 ){

                //Setting x position of particle system the same as the corresponding note
                const xPosition = getPositionX(noteBlockArray[i].note);
                particleSystem_keyPressed[particleElement] = new ParticleSystem_KeyPressed(xPosition, noteBlockArray[i].note);
                scene.add(particleSystem_keyPressed[particleElement].particleSystem);
                particleElement++;
            }     
        }
        console.log('init DONE');
    }


function main(){

    //Start keyboard input
    keyboard.startInputOutput(song);

    //Large particleSystem
    setUpParticleSystem();

    //Loading geometries to scene
    loadGeometries();
    
    init();

    //Start visualization
    animate();

  //  jingleBells2.playSong();

    // start clock
    startTime = getStartTime();

}    

//Starting program
main();

var blockpos = Math.tan(75*0.5*(Math.PI/180))*10;
    line.position.y = -blockpos;

function animate(){

    var velocity = tempo * 1000,
    elapsedTime = getCurrentTime() - startTime;

if(elapsedTime >= 1000 && letsGo == -1)
{
    getStartText('LETS GO');
    letsGo = 1;
}

if(elapsedTime >= 2500)
{
    scene.remove(textMesh);
}

     if(elapsedTime >= noteBlockArray[0].startTime && asd2 == -1)
  {
      console.log('Nu hände de');
      jingleTest.setVolume(0.4);
      jingleTest.playSong();
      asd2 = 1;
  }

    renderParticles();

    particleSystem.rotation.y += 0.001;
    
    // Trigger GameOVer sequence
   // if(elapsedTime > noteBlockArray[noteBlockArray.length-1].stopTime + 1000 )
    //    initEndingAnimation(getScore());

    if(blockIndex < noteBlockArray.length)
        var lengthToTravel = 2 * blockpos - noteBlockArray[blockIndex].noteLength/2;
    
    //Adding note blocks to scene (depending on song)
    while(blockIndex < noteBlockArray.length && elapsedTime >= Math.round(Math.abs(noteBlockArray[blockIndex].startTime - 1000*lengthToTravel/velocity))){
        if(blockIndex+1 < noteBlockArray.length && noteBlockArray[blockIndex].startTime == noteBlockArray[blockIndex+1].startTime)
        {
            
                        //Adding group of note blocks
            addChordNoteBlocks(noteBlockArray[blockIndex], noteBlockArray[blockIndex+1]);
           // setUpExplosion(getPositionX(noteBlockArray[blockIndex].mesh.position.x )); }
        }
        else
        //  scene.remove(textMesh);
      //  getStartText('rty');
            addSingleNoteBlock(noteBlockArray[blockIndex]);
          //  setUpExplosion(getPositionX(noteBlockArray[blockIndex].mesh.position.x )); }

    }

            
    //Removing block when not active
    for(var i = 0; i < blockIndex; i++){
        
        if( noteBlockArray[i].active == true && elapsedTime > Math.round(noteBlockArray[i].stopTime)){
            scene.remove(noteBlockArray[i].mesh);
            noteBlockArray[i].active = false;
        }
    } 
            
    //Update score
    dynamicTexture.clear('blue').drawText(getScore(), 150, 500, 'white');
    dynamicTexture.clear('blue').drawText(getScore(), 50, 500, 'white');
    animationID = requestAnimationFrame(animate);
        updatePositions(elapsedTime, blockpos);

    //Render frame
    renderer.autoClear = false;
    renderer.clear();

    //Left camera
    renderer.setViewport( 0, 0, width, height);
    renderer.setScissor( 0, 0, width, height);
    renderer.setScissorTest ( true );
    cameraLeft.aspect = width * 2 / height;
    cameraLeft.updateProjectionMatrix();
    composer.render();
    composer2.render();
  
    //Right camera
    renderer.setViewport( width, 0, width, height);
    renderer.setScissor( width, 0, width, height);
    renderer.setScissorTest ( true );
    cameraRight.aspect = width * 2 / height;
    cameraRight.updateProjectionMatrix();
    composer2.render();
   
}

function renderParticles(noteblock){

    var delta = clock.getDelta() * particleSystem_keyPressed[0].spawnerOptions.timeScale;
    tick += delta;

    if ( tick < 0 ) tick = 0;

    if ( delta > 0 ) {

        for ( let x = 0; x < particleSystem_keyPressed[0].spawnerOptions.spawnRate * delta; x++ ) {

            //Spawning particles is super cheap, and once you spawn them, the rest of
            // their lifecycle is handled entirely on the GPU, driven by a time uniform updated below
            for(let i = 0; i < particleSystem_keyPressed.length; ++i){
                 particleSystem_keyPressed[i].particleSystem.spawnParticle( particleSystem_keyPressed[i].options );
            }
        }
    }

   // particleSystem1.position.x 
    for(let i = 0; i < particleSystem_keyPressed.length; ++i)
        particleSystem_keyPressed[i].particleSystem.update( tick );
}

//FUNCTIONS

    // Function to load geometries
    function loadGeometries(){

        var light = new THREE.DirectionalLight( 0xb4e7f2, 5 );
       // light.position.set( 5, -3.5, 5 );
       light.position.set( 5, 5, 5 );
        scene.add( light );

        scene.add(particleSystem);
        //Loading note blocks from picked song
        noteBlockArray = loadNoteBlocks();

        console.log('loadGeometries DONE');
    }

function setUpParticleSystem(){
    for (var p = 0; p < particleCount; p++){
    // create a particle with random postion values
    var pX = Math.random() * 10 - 5,
        pY = Math.random() * 500 - 250,
        pZ = Math.random() * 20 - 10,
        particle = new THREE.Vector3(pX, pY, pZ);
    particleSystem = new THREE.Points( particles, pMaterial);
    // add it to the geometry
    //particleSystem.position.set(1, 1, 1);
    particles.vertices.push(particle);
}
console.log('setUpParticleSystem DONE');
// add it to the scene
//scene.add(particleSystem);
}
/*
function setUpExplosion(xpos){
    for (var p = 0; p < particleCount2; p++){
    // create a particle with random postion values
    var pX2 = xpos,
        pY2 = Math.random() * 20 - 10,
        pZ2 = Math.random() * 20 - 10,
        particle2 = new THREE.Vector3(pX2, pY2, pZ2);
    particleSystem2 = new THREE.Points( particles2, pMaterial2);
    // add it to the geometry
    //particleSystem.position.set(1, 1, 1);
    particles2.vertices.push(particle2);
}
// add it to the scene
scene.add(particleSystem2);
}
*/

function addChordNoteBlocks(noteBlock1, noteBlock2){

    meshGroup.add(noteBlock1.mesh);
    meshGroup.add(noteBlock2.mesh);
    scene.add(meshGroup);
    noteBlock1.active = true;
    noteBlock2.active = true;
    noteBlock1.mesh.position.x = getPositionX(noteBlock1.note);
    noteBlock2.mesh.position.x = getPositionX(noteBlock2.note);
    noteBlock1.mesh.position.y = -meshGroup.position.y + blockpos + noteBlock1.noteLength/2;
    noteBlock2.mesh.position.y = noteBlock1.mesh.position.y + (noteBlock2.noteLength)/2 - (noteBlock1.noteLength)/2;
    blockIndex += 2;
}


function addSingleNoteBlock(noteBlock){
    
    meshGroup.add(noteBlock.mesh);
    scene.add(meshGroup);
    noteBlock.active = true;

    noteBlock.mesh.position.x = getPositionX(noteBlock.note);

    // ERROR here. This particular noteblock gets misplaced. This fixes it temporarily
   if(noteBlock.note == 'G4' && noteBlock.startTime == 11200)
    {

        noteBlock.mesh.position.y = - meshGroup.position.y + blockpos + noteBlock.noteLength/4;
    }
    else
    {
        noteBlock.mesh.position.y = - meshGroup.position.y + blockpos + noteBlock.noteLength/2;
    }
    
    blockIndex++;
}

function updatePositions(elapsedTime, blockpos){
    //cameraLeft.position.y = elapsedTime * tempo;
    //cameraRight.position.y = elapsedTime * tempo;
    meshGroup.position.y = -elapsedTime * tempo;
    // axis.position.y = cameraLeft.position.y +5;
}

    //Setting tempo depending on song picked
    function getSongTempo(s){

        var chosenTempo = location.search.substring(1).split("?")[4];

            if ( chosenTempo == "Low" && s == 'korv' ) {chosenTempo = 0.0035;}
            if ( chosenTempo == "Medium" && s == 'korv' ) {chosenTempo = 0.005;}
            if ( chosenTempo == "High" && s == 'korv' ) {chosenTempo = 0.007;}

        switch(s){

            case 'roses': tempo = 0.01; break;
            case 'jason_mraz': tempo = 0.005; break;
            case 'korv': tempo = chosenTempo; break;
            default: tempo = 0.001; break;
        }
        return tempo;
}


function sendID(){
    window.location.href = "GUI/GameOver.html?" + 
                           location.search.substring(1).split("?")[0] + '?' +
                           location.search.substring(1).split("?")[1] + '?' +
                           location.search.substring(1).split("?")[2] + '?' +
                           totalpoints;
}
function initEndingAnimation(totalpoints){
    document.getElementById('playground').style.animation = "fadeout 4s";
    setTimeout(sendID, 2000);

}

function getSetupInfo(){

    let noKeys = location.search.substring(1).split("?")[0],
    
    noWhiteKeys = 0,
    noBlackKeys = 0;

    if(noKeys == 49)
    {
        noWhiteKeys = 29;
        noBlackKeys = 20;
    }
    else if(noKeys == 61)
    {
        noWhiteKeys = 36;
        noBlackKeys = 25;
    }
    else
    {
        noWhiteKeys = 88 - 36;
        noBlackKeys = 36;
    }   

        // Extracting calibrated right- and left line positions from URL
          var right = location.search.substring(1).split("?")[1],
              left = location.search.substring(1).split("?")[2];

              if(left.includes('-'))
                {
                    left = -left.split("-").pop();
                }

    var URLarray = [];
    URLarray[0] = noWhiteKeys;
    URLarray[1] = noBlackKeys;
    URLarray[2] = right;
    URLarray[3] = left;

    return URLarray;

}

function getStartText(startNum)
{

loader.load( 'lib/normaltextfont.js', function ( font ) {

  var textGeometry = new THREE.TextGeometry( startNum, {

    font: font,

    size: 1,
    height: 0.5,
    curveSegments: 12,

    bevelThickness: 0.05,
    bevelSize: 0.05,
    bevelEnabled: true

  });

  textMaterial = new THREE.MeshPhongMaterial( 
    { color: 0xff0000, specular: 0xffffff }
  );

  textMesh = new THREE.Mesh( textGeometry, textMaterial );


  textMesh.position.x = -1;
  textMesh.position.y = 0;
  textMesh.position.z = 2;

  scene.add( textMesh );

});


}


</script>
</body>

</html>
