<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
<meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>Piano-projector</title>

<!-- Midi.js package -->
<script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
<!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->
<script src = "lib/MIDI.js-master/js/midi/audioDetect.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/gm.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/loader.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/player.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/plugin.audiotag.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/plugin.webaudio.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/plugin.webmidi.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/synesthesia.js"> </script>
<script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>    
<script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
<script src ="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
<script src ="lib/MIDI.js-master/examples/inc/event.js"></script>
<script src ="lib/MIDI.js-master/examples/inc/timer.js"></script>
<!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->

<!-- Other external libraries -->
<script src = "lib/soundfontplayer.js"> </script>
<script src = "lib/webmidi/src/webmidi.js"> </script>
<script src="lib\three.js-master\docs\build\three.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
<script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>

<!-- Internal js files -->
<script src = "NoteBlock.js"></script>
<script src = "EventReader.js"></script>
<script src = "Song.js"></script>
<script src = "Clock.js"></script>
<script src = "parseSongData.js"></script>
<script src = "getSongArray.js"></script>
<script src = "keyEffects.js"></script>
<script src = "PointGiver.js"></script>
<script src = "SongResizer.js"></script>
<script src = "Keyboard.js"></script>
<script src = "midi-player.js"></script>


</head>
<body>
<script>


//Global variables
var keyboard = new Keyboard();
var song = new Song(location.search.substring(1).split("?")[0]);
var errorSound = new Audio('./songs-mp3/error.wav');
var noteBlockArray = [];
var blockIndex = 0;
var tempo = getSongTempo(location.search.substring(1).split("?")[0]);
//var fullScoreCounter = 0;
//var starPower = false;


function main(){

    //Start keyboard input
    keyboard.startInputOutput(song);

    //Start visualization
    animate();

    //Play picked song
    song.setVolume(0.4);
    song.playSong();
    startClock();

}

//Creating scene
var scene = new THREE.Scene();
var renderer = new THREE.WebGLRenderer();
renderer.setSize( window.innerWidth, window.innerHeight );
renderer.setClearColor( 0xfaf0e6 );
document.body.appendChild( renderer.domElement )

//2D camera
//var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
//camera.position.z = 10;

//3D camera
cameraLeft = new THREE.PerspectiveCamera( 45, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
cameraLeft.position.set( 0, 0, 10 );
scene.add(cameraLeft);
cameraRight = new THREE.PerspectiveCamera( 45, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
cameraRight.position.set( 0, 0, 10);
scene.add(cameraRight);
var width = Math.round(window.innerWidth / 2),
    height = window.innerHeight;

var g = new THREE.BoxGeometry(40,0.3,0.2);
var m = new THREE.MeshPhongMaterial({color:0x000000});
var line = new THREE.Mesh(g,m);
var blockpos = 0;
scene.add(line);

//Setting up for post-processing////////

var rightRenderPass = new THREE.RenderPass(scene, cameraRight);
var leftRenderPass = new THREE.RenderPass(scene, cameraLeft);
var effectCopy = new THREE.ShaderPass(THREE.CopyShader);
effectCopy.renderToScreen=true;

var composer = new THREE.EffectComposer(renderer);
composer.addPass(rightRenderPass);
composer.addPass(leftRenderPass);
composer.addPass(bloomPass);

var renderScene = new THREE.TexturePass(composer.renderTarget2);
///////////////////////////////////////////////////

//Loading geometries to scene
loadGeometries();
//Starting program
main();

//Theoretical effects-renderer//////////////
    
    var bloomPass = new THREE.BloomPass(3, 25, 5, 256);
    var bloomComposer = new THREE.EffectComposer(renderer);
    bloomComposer.addPass(renderScene);
    bloomComposer.addPass(bloomPass);
    bloomComposer.addPass(effectCopy);
////////////////////////////////////////////

function animate(){


if(blockIndex < noteBlockArray.length) {

    blockpos = Math.tan(75*0.5*(Math.PI/180))*cameraLeft.position.z + noteBlockArray[blockIndex].noteLength/2;
}

    //Adding note blocks to scene (depending on song)
    console.log('starttime: ' + noteBlockArray[blockIndex].startTime);
    console.log('clock: ' + getClockTime());

    console.log('blockpos: ' + blockpos/2);

if(blockIndex < noteBlockArray.length && getClockTime() == Math.round(noteBlockArray[blockIndex].startTime - (10*blockpos/(tempo*60)))){

    scene.add(noteBlockArray[blockIndex].mesh);
    noteBlockArray[blockIndex].mesh.position.x = getPositionX(noteBlockArray[blockIndex].note);

    noteBlockArray[blockIndex].mesh.position.y = cameraLeft.position.y + blockpos/2;


    blockIndex++;

    console.log('Blockindex: ' + blockIndex);
        
}

    //Translating blocks 
    cameraLeft.position.y += tempo;
    cameraRight.position.y += tempo;
    line.position.y = cameraLeft.position.y - 6;
    //line.position.y = cameraRight.position.y - 6;

    requestAnimationFrame(animate);

    //Animate the BloomPass-effect////
    composer.animate(scene, cameraRight);
    composer.animate(scene, cameraLeft);
    
    renderer.setViewport( 0, 0, width, height);
    renderer.setScissor( 0, 0, width, height);
    renderer.setScissorTest ( true );
    cameraLeft.aspect = width * 2 / height;
    cameraLeft.updateProjectionMatrix();
    //cameraLeft.position.x = -separation;
    renderer.render( scene, cameraLeft );
    renderer.setViewport( width, 0, width, height);
    renderer.setScissor( width, 0, width, height);
    renderer.setScissorTest ( true );
    cameraRight.aspect = width * 2 / height;
    cameraRight.updateProjectionMatrix();
    //cameraRight.position.x = separation;
    renderer.render( scene, cameraRight );
     
}

function loadGeometries(){

    var light = new THREE.DirectionalLight( 0xb4e7f2, 5 );
    light.position.set( 5, 5, 5 );
    scene.add( light );

    //Loading note blocks from picked song
    noteBlockArray = loadNoteBlocks();

}

/**
* Returning note block x position
*/
function getPositionX(n){

    let res = 0;

        switch(n){
        case 'C3':  res = -12; break;
        case 'Db3':  res = -11; break;
        case 'D3':  res = -10; break;
        case 'Eb3':  res = -9; break;
        case 'E3':  res = -8; break;
        case 'F3':  res = -6; break;
        case 'Gb3':  res = -5; break;
        case 'G3':  res = -4; break;
        case 'Ab3':  res = -3; break;
        case 'A3':  res = -2; break;
        case 'Bb3':  res = -1; break;
        case 'B3':  res = 0; break;
        case 'C4':  res = 2;  break;
        case 'Db4':  res = 3; break;
        case 'D4':  res = 4; break;
        case 'Eb4':  res = 5; break;
        case 'E4':  res = 6; break;
        case 'F4':  res = 2; break;
        case 'Gb4':  res = 9; break;
        case 'G4':  res = 3; break;
        case 'Ab4':  res = 11; break;
        case 'A4':  res = 4; break;
        case 'Bb4':  res = 13; break;
        case 'B4':  res = 14; break;
        default: res = 0;  break;
    }

    return res;
}

//Setting tempo depending on song picked
function getSongTempo(s){

    switch(s){

        case 'roses': tempo = 0.035; break;
        case 'jason_mraz': tempo = 0.5; break;
        case 'korv': tempo = 0.2; break;

        default: tempo = 0.001; break;
    }

    return tempo;
}


</script>
</body>
</html>