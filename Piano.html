<!DOCTYPE html>
<html id="playground">
<head>

    <link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
    <meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Piano-projector</title>

    <!-- Midi.js package -->
    <script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->
    <script src="lib/MIDI.js-master/js/midi/audioDetect.js"></script>
    <script src="lib/MIDI.js-master/js/midi/gm.js"></script>
    <script src="lib/MIDI.js-master/js/midi/loader.js"></script>
    <script src="lib/MIDI.js-master/js/midi/player.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.audiotag.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webaudio.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webmidi.js"></script>
    <script src="lib/MIDI.js-master/js/midi/synesthesia.js"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/event.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/timer.js"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->

    <!-- Other external libraries -->
    <script src="lib/soundfontplayer.js"></script>
    <script src="lib/webmidi/src/webmidi.js"></script>
    <script src="lib\threex.dynamictexture.js"></script>
    <script src="lib\three.js-master\docs\build\three.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
    <script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/BloomPass.js"></script>
    <script src="lib/three.js-master/examples/js/shaders/ConvolutionShader.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/TexturePass.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/BloomBlendPass.js"></script>

    <!-- Internal js files -->
    <script src="getPositionX.js"></script>
    <script src="NoteBlock.js"></script>
    <script src="EventReader.js"></script>
    <script src="Song.js"></script>
    <script src="Clock.js"></script>
    <script src="parseSongData.js"></script>
    <script src="getSongArray.js"></script>
    <script src="keyEffects.js"></script>
    <script src="PointGiver.js"></script>
    <script src="SongResizer.js"></script>
    <script src="Keyboard.js"></script>
    <script src="midi-player.js"></script>
    


</head>

<body>
<script>

//Global variables
var keyboard = new Keyboard();
var song = new Song(location.search.substring(1).split("?")[1]);
var errorSound = new Audio('./songs-mp3/error.wav');
var noteBlockArray = [];
var delBlockArray = [];
var blockIndex = 0;
var tempo = getSongTempo(location.search.substring(1).split("?")[1]);
var animationID;

var startTime;
//var fullScoreCounter = 0;
//var starPower = false;

function main(){

    //Start keyboard input
    keyboard.startInputOutput(song);

    //Start visualization
    animate();

    //Play picked song
    song.setVolume(0.4);
    song.playSong();

    startTime = getStartTime();


}

//Creating a scene
var scene = new THREE.Scene();


/*        //Create black line at bottom of scene
        var geometry = new THREE.BoxGeometry(20, 0.2, 1);
        var material = new THREE.MeshPhongMaterial({ color: 0x050505, transparent: true, opacity: 0.8 });
        var material2 = new THREE.MeshPhongMaterial({ color: 0xff0000, transparent: true, opacity: 0.8 });
        var line = new THREE.Mesh(geometry, material);
        scene.add(line);*/

        //Create test box
        var geometry = new THREE.BoxGeometry(2, 2, 2);
        var material = new THREE.MeshPhongMaterial({color: 0xff0000, wireframe: true});
        var box = new THREE.Mesh(geometry, material);
        
        // scene.add(box);

        var axisHelper = new THREE.AxisHelper(3);
        
        scene.add(axisHelper);

//2D camera
/*
var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
camera.position.z = 10;
*/


//3D camera

cameraLeft = new THREE.PerspectiveCamera( 75, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
//var helper1 = new THREE.CameraHelper(cameraLeft);
//scene.add(helper1);
cameraLeft.position.set( 0, 0, 10 );
scene.add(cameraLeft);

cameraRight = new THREE.PerspectiveCamera( 75, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
cameraRight.position.set( 0, 0, 10);
scene.add(cameraRight);

/*cameraLeft = new THREE.PerspectiveCamera( 30.07, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
//var helper1 = new THREE.CameraHelper(cameraLeft);
//scene.add(helper1);
cameraLeft.position.set(-0.08, -3.89, 5.16);
cameraRight.lookAt(scene.position);
scene.add(cameraLeft);

cameraRight = new THREE.PerspectiveCamera( 30.07, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
cameraRight.position.set(0.08, -3.89, 5.16);
cameraRight.lookAt(scene.position);
scene.add(cameraRight);*/

var theHeight = 2 * Math.tan( ( 75*Math.PI/180 / 2 ) ) * cameraLeft.position.z;

    var linegeometry = new THREE.Geometry();
    var linematerial = new THREE.LineBasicMaterial({ color: 0x0000ff });
    linegeometry.vertices.push(new THREE.Vector3(0, -10, 0));
    linegeometry.vertices.push(new THREE.Vector3(0, 10, 0));
    var theLine = new THREE.Line(linegeometry, linematerial);
    var theLine2 = new THREE.Line(linegeometry, linematerial);

    scene.add(theLine);
    scene.add(theLine2);
    theLine.position.x = 11.05;
    theLine2.position.x = -10.22;
    
let width = Math.round(window.innerWidth / 2),
    height = window.innerHeight;

//Creating a renderer
var renderer = new THREE.WebGLRenderer();
renderer.setSize( window.innerWidth, window.innerHeight );
renderer.setClearColor( 0x000000 );
//document.body.appendChild( renderer.domElement );

renderer.shadowMapEnabled = true;

var theTime = new Date();

//Loading geometries to scene
loadGeometries();
document.body.appendChild(renderer.domElement);

//PASSES
        var renderPass1 = new THREE.RenderPass(scene, cameraLeft);
        var renderPass2 = new THREE.RenderPass(scene, cameraRight);
        var effectCopy = new THREE.ShaderPass(THREE.CopyShader);
        //effectCopy.renderToScreen = true;
        //var bloomPass = new THREE.BloomBlendPass( 10, 3, new THREE.Vector2(100, 20));
        var bloomPass = new THREE.BloomBlendPass( 10.0, 0.8, new THREE.Vector2(64, 64));
        bloomPass.renderToScreen = true;

//First composer
        var composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderPass1);
        composer.addPass(renderPass2);
        composer.addPass(effectCopy);
        var renderScene = new THREE.TexturePass(composer.renderTarget2);

//Second composer (BloomPass)
    var composer2 = new THREE.EffectComposer(renderer);
        composer2.addPass(renderScene);
        composer2.addPass(bloomPass);
        composer2.addPass(effectCopy);

//Render
      //  animate();


    //Creating scoreboard
    var dynamicTexture  = new THREEx.DynamicTexture(512,512*2);
    dynamicTexture.context.font	= "bolder 200px Verdana";
    var scoreGeo = new THREE.BoxGeometry(12, 2, 2);
    var scoreMat = new THREE.MeshPhongMaterial({ map : dynamicTexture.texture, specular: 10});
    var side1 = new THREE.MeshPhongMaterial({ color: 0x0000ff });
    var side2 = new THREE.MeshPhongMaterial({ color: 0x0000ff });
    var side3 = new THREE.MeshPhongMaterial({ color: 0x0000ff });
    var materials = [scoreMat, side1, side2, side3];
    var meshFaceMaterial = new THREE.MeshFaceMaterial( materials );


    var scoreBoard = new THREE.Mesh(scoreGeo, scoreMat);
  // var scoreBoard = new THREE.Mesh(scoreGeo, meshFaceMaterial);


    scoreBoard.position.set(-10,12,0);
    scoreBoard.rotation.x = Math.PI/45;
    scoreBoard.rotation.y = -Math.PI/45;
    //scoreBoard.rotation.y = Math.PI/10;
    scene.add(scoreBoard);
    dynamicTexture.texture.needsUpdate = true;

//Starting program
main();
var velCounter = 1;

function animate(){

    blockpos = Math.tan(75*0.5*(Math.PI/180))*cameraLeft.position.z + 1;
    var velocity = tempo * 1000;
    var elapsedTime = getCurrentTime() - startTime;

    if(elapsedTime > noteBlockArray[noteBlockArray.length-1].stopTime + 1000 )
    initEndingAnimation(getScore());

    if(blockIndex < noteBlockArray.length) {
        var lengthToTravel = 2 * blockpos - noteBlockArray[blockIndex].noteLength/2;
         // console.log(elapsedTime*tempo / velCounter);
    }
    
    //Adding note blocks to scene (depending on song)

    while(blockIndex < noteBlockArray.length && elapsedTime >= Math.round(Math.abs(noteBlockArray[blockIndex].startTime - 1000*lengthToTravel/velocity))){

        if(blockIndex+1 < noteBlockArray.length && noteBlockArray[blockIndex].startTime == noteBlockArray[blockIndex+1].startTime)
        {
            
            scene.add(noteBlockArray[blockIndex].mesh);
            scene.add(noteBlockArray[blockIndex+1].mesh);

            noteBlockArray[blockIndex].active = true;
            noteBlockArray[blockIndex+1].active = true;

            noteBlockArray[blockIndex].mesh.position.x = getPositionX(noteBlockArray[blockIndex].note);
            noteBlockArray[blockIndex+1].mesh.position.x = getPositionX(noteBlockArray[blockIndex+1].note);

            noteBlockArray[blockIndex].mesh.position.y = cameraLeft.position.y + blockpos + noteBlockArray[blockIndex].noteLength/2;
            noteBlockArray[blockIndex+1].mesh.position.y = noteBlockArray[blockIndex].mesh.position.y + (noteBlockArray[blockIndex+1].noteLength)/2 - (noteBlockArray[blockIndex].noteLength)/2;
        }
    }
   
    //implementera loop, peka på äldsta noten
    //Removing block when not active
    for(var i = 0; i < blockIndex; i++){
        if( noteBlockArray[i].active == true && elapsedTime > Math.round(noteBlockArray[i].stopTime)){
            scene.remove(noteBlockArray[i].mesh);
            noteBlockArray[i].active = false;
        }
    }

/*
//implementera loop, peka på äldsta noten
   if(blockIndex < delBlockArray.length && elapsedTime > Math.round(delBlockArray[0].stopTime))
   {
        scene.remove(noteBlockArray[blockIndex].mesh);
        delBlockArray.splice(0, 1);
      //  console.log('Deleted');
   }
*/
    //Update score
    dynamicTexture.clear('blue').drawText(getScore(), 150, 500, 'white');


    //Translating blocks 
    cameraLeft.position.y = elapsedTime * tempo;
    cameraRight.position.y = elapsedTime * tempo;
    velCounter++;

    line.position.y = cameraLeft.position.y-blockpos+1;
    theLine.position.y = cameraLeft.position.y;
    theLine2.position.y = cameraLeft.position.y;
    scoreBoard.position.y = cameraLeft.position.y +5;

    requestAnimationFrame(animate);

    renderer.setViewport( 0, 0, width, height);
    renderer.setScissor( 0, 0, width, height);
    renderer.setScissorTest ( true );
    cameraLeft.aspect = width * 2 / height;
    cameraLeft.updateProjectionMatrix();
    composer.render();
    composer2.render();
    //renderer.render( scene, cameraLeft );
    //cameraLeft.position.x = -separation;
  
    //renderer.render( scene, cameraLeft );
    renderer.setViewport( width, 0, width, height);
    renderer.setScissor( width, 0, width, height);
    renderer.setScissorTest ( true );
    cameraRight.aspect = width * 2 / height;
    cameraRight.updateProjectionMatrix();

    //cameraRight.position.x = separation; 
    //renderer.render( scene, cameraRight );
   composer2.render();
}

function loadGeometries(){

    var light = new THREE.DirectionalLight( 0xb4e7f2, 5 );
    //light.position.set( 5, -5, -4 );
    light.position.set( 5, 5, 5 );
    scene.add( light );
    //Loading note blocks from picked song
    noteBlockArray = loadNoteBlocks();

  //  delBlockArray = loadNoteBlocks();
}


//Setting tempo depending on song picked
function getSongTempo(s){
    switch(s){


        case 'roses': tempo = 0.01; break;
        case 'jason_mraz': tempo = 0.005; break;
        case 'korv': tempo = 0.007; break;


        default: tempo = 0.001; break;
    }
    return tempo;
}

function sendID(){
    window.location.href = "GUI/GameOver.html?" + totalpoints;
}

function initEndingAnimation(totalpoints){
    document.getElementById('playground').style.animation = "fadeout 4s";
    setTimeout(sendID, 2000);
}

</script>
</body>


</html>

