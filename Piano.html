<!DOCTYPE html>
<html id="playground">

<head>

    <link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
    <meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Piano-projector</title>

    <!-- Midi.js package -->
    <script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->
    <script src="lib/MIDI.js-master/js/midi/audioDetect.js"></script>
    <script src="lib/MIDI.js-master/js/midi/gm.js"></script>
    <script src="lib/MIDI.js-master/js/midi/loader.js"></script>
    <script src="lib/MIDI.js-master/js/midi/player.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.audiotag.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webaudio.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webmidi.js"></script>
    <script src="lib/MIDI.js-master/js/midi/synesthesia.js"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/event.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/timer.js"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->

    <!-- Other external libraries -->
    <script src="lib/soundfontplayer.js"></script>
    <script src="lib/webmidi/src/webmidi.js"></script>
    <script src="lib\threex.dynamictexture.js"></script>
    <script src="lib\three.js-master\docs\build\three.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
    <script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/BloomPass.js"></script>
    <script src="lib/three.js-master/examples/js/shaders/ConvolutionShader.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/TexturePass.js"></script>
    <script src="lib/three.js-master/examples/js/postprocessing/BloomBlendPass.js"></script>

    <!-- Internal js files -->
    <script src="getPositionX.js"></script>
    <script src="NoteBlock.js"></script>
    <script src="EventReader.js"></script>
    <script src="Song.js"></script>
    <script src="Clock.js"></script>
    <script src="parseSongData.js"></script>
    <script src="getSongArray.js"></script>
    <script src="keyEffects.js"></script>
    <script src="PointGiver.js"></script>
    <script src="SongResizer.js"></script>
    <script src="Keyboard.js"></script>
    <script src="midi-player.js"></script>

</head>

<body>
    <script>
        //Global variables
        var keyboard = new Keyboard();
        var song = new Song(location.search.substring(1).split("?")[1]);
        var errorSound = new Audio('./songs-mp3/error.wav');
        var noteBlockArray = [];
        var delBlockArray = [];
        var blockIndex = 0;
        var tempo = getSongTempo(location.search.substring(1).split("?")[1]);
        var animationID;
        var startTime;

        var meshGroup = new THREE.Object3D();

        //Creating a scene
        var scene = new THREE.Scene();

        //Create black line at bottom of scene
        var geometry = new THREE.BoxGeometry(22, 0.2, 1);
        var material = new THREE.MeshPhongMaterial({ color: 0x00ff00, transparent: true, opacity: 0.8 });
        // var material2 = new THREE.MeshPhongMaterial({ color: 0xff0000, transparent: true, opacity: 0.8 });
        var line = new THREE.Mesh(geometry, material);
        scene.add(line);

        /* Create two cameras for side-by-side 3D projection*/
        cameraL = new THREE.Camera();
        cameraL.position.set(-0.206 * 4, -3.89 * 4, 5.16 * 4);
        // cameraL.position.set(-0.032, -0.6025, 0.80);

        cameraLeft = realView(cameraL);
        scene.add(cameraLeft);


        cameraR = new THREE.Camera();
        cameraR.position.set(0.206 * 4, -3.89 * 4, 5.16 * 4);
        // cameraR.position.set(0.032, -0.6025, 0.80);

        cameraRight = realView(cameraR);
        scene.add(cameraRight);

        let width = Math.round(window.innerWidth / 2),
            height = window.innerHeight;

        //Verticle lines for keyboard calibration
        var linegeometry = new THREE.Geometry();
        var linematerial = new THREE.LineBasicMaterial({ color: 0x0000ff });
        linegeometry.vertices.push(new THREE.Vector3(0, -10, 0));
        linegeometry.vertices.push(new THREE.Vector3(0, 10, 0));
        var theLine = new THREE.Line(linegeometry, linematerial);
        var theLine2 = new THREE.Line(linegeometry, linematerial);
        theLine.position.x = 11.05;
        theLine2.position.x = -10.22;
        scene.add(theLine);
        scene.add(theLine2);


        //Creating a renderer
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000);
        document.body.appendChild(renderer.domElement);

        renderer.shadowMapEnabled = true;

        //Loading geometries to scene
        loadGeometries();

        //Creating scoreboard
        var dynamicTexture = new THREEx.DynamicTexture(512, 512 * 2);
        dynamicTexture.context.font = "bolder 200px Verdana";
        var scoreGeo = new THREE.BoxGeometry(7, 2, 2);
        var scoreMat = new THREE.MeshPhongMaterial({ map: dynamicTexture.texture, specular: 10 });
        var side1 = new THREE.MeshPhongMaterial({ color: 0x0000ff });
        var side2 = new THREE.MeshPhongMaterial({ color: 0x0000ff });
        var side3 = new THREE.MeshPhongMaterial({ color: 0x0000ff });
        var materials = [scoreMat, side1, side2, side3];
        var meshFaceMaterial = new THREE.MeshFaceMaterial(materials);

        var scoreBoard = new THREE.Mesh(scoreGeo, scoreMat);

        scoreBoard.position.set(-10, 7, 0);
        scoreBoard.rotation.x = Math.PI / 45;
        scoreBoard.rotation.y = -Math.PI / 45;
        scene.add(scoreBoard);
        dynamicTexture.texture.needsUpdate = true;

        //Starting program
        main();


        /*********  Functions    *********/

        function main() {

            //Start keyboard input
            keyboard.startInputOutput(song);

            //Start visualization
            animate();

            //Play picked song
            song.setVolume(0.4);
            song.playSong();

            startTime = getStartTime();
        }

        //Render loop
        function animate() {

            //Updating values
            blockpos = Math.tan(75 * 0.5 * (Math.PI / 180)) * 10 + 1;
            var velocity = tempo * 1000,
                elapsedTime = getCurrentTime() - startTime;

            //If game has ended, init "game over"-animation
            if (elapsedTime > noteBlockArray[noteBlockArray.length - 1].stopTime + 1000)
                initEndingAnimation(getScore());

            if (blockIndex < noteBlockArray.length)
                var lengthToTravel = 2 * blockpos - noteBlockArray[blockIndex].noteLength / 2;

            //Adding note blocks to scene (depending on song)
            while (blockIndex < noteBlockArray.length && elapsedTime >= Math.round(Math.abs(noteBlockArray[blockIndex].startTime - 1000 * lengthToTravel / velocity))) {

                if (blockIndex + 1 < noteBlockArray.length && noteBlockArray[blockIndex].startTime == noteBlockArray[blockIndex + 1].startTime)
                    //Adding group of note blocks
                    addChordNoteBlocks(noteBlockArray[blockIndex], noteBlockArray[blockIndex + 1]);

                else
                    addSingleNoteBlock(noteBlockArray[blockIndex]);
            }

            //Removing block when not active
            for (var i = 0; i < blockIndex; i++) {
                if (noteBlockArray[i].active == true && elapsedTime > Math.round(noteBlockArray[i].stopTime)) {
                    scene.remove(noteBlockArray[i].mesh);
                    noteBlockArray[i].active = false;
                }
            }

            //Update score
            dynamicTexture.clear('blue').drawText(getScore(), 150, 500, 'white');

            //Translating blocks 
            // updatePositions(elapsedTime, blockpos);
            meshGroup.position.y = -elapsedTime * tempo;
            line.position.y = -blockpos + 1.5;

            //Updating frame
            requestAnimationFrame(animate);

            //Render frame
            //Left camera
            renderer.setViewport(0, 0, width, height);
            renderer.setScissor(0, 0, width, height);
            renderer.setScissorTest(true);
            // cameraL.aspect = width * 2 / height;
            // cameraRight.updateMatrixWorld( true );
            // composer.render();
            renderer.render(scene, cameraLeft);

            //Right camera
            renderer.setViewport(width, 0, width, height);
            renderer.setScissor(width, 0, width, height);
            renderer.setScissorTest(true);
            // cameraR.aspect = width * 2 / height;
            // cameraRight.updateMatrixWorld(true);
            // composer2.render();
            renderer.render(scene, cameraRight);


        }

        function loadGeometries() {

            var light = new THREE.PointLight(0xb4e7f2, 2);
            light.position.set(10, 8, 8);
            scene.add(light);

            var light2 = new THREE.PointLight(0xb4e7f2, 2);
            light2.position.set(-10, 8, 8);
            scene.add(light2);

            var light3 = new THREE.PointLight(0xb4e7f2, 2);
            light3.position.set(0, -8, 2);
            scene.add(light3);

            var light4 = new THREE.PointLight(0xb4e7f2, 2);
            light3.position.set(0, -4, 0);
            scene.add(light4);

            //Loading note blocks from picked song
            noteBlockArray = loadNoteBlocks();
        }

        function addChordNoteBlocks(noteBlock1, noteBlock2) {

            meshGroup.add(noteBlock1.mesh);
            meshGroup.add(noteBlock2.mesh);
            /*scene.add(noteBlock1.mesh);
            scene.add(noteBlock2.mesh);*/
            scene.add(meshGroup);

            noteBlock1.active = true;
            noteBlock2.active = true;

            noteBlock1.mesh.position.x = getPositionX(noteBlock1.note);
            noteBlock2.mesh.position.x = getPositionX(noteBlock2.note);

            noteBlock1.mesh.position.y = cameraL.position.y + blockpos + noteBlock1.noteLength / 2;
            noteBlock2.mesh.position.y = noteBlock1.mesh.position.y + (noteBlock2.noteLength) / 2 - (noteBlock1.noteLength) / 2;

            blockIndex += 2;
        }

        function addSingleNoteBlock(noteBlock) {

            meshGroup.add(noteBlock.mesh);
            scene.add(meshGroup);
            //scene.add(noteBlock.mesh);
            noteBlock.active = true;

            noteBlock.mesh.position.x = getPositionX(noteBlock.note);
            noteBlock.mesh.position.y = - meshGroup.position.y + blockpos + noteBlock.noteLength / 2;
            blockIndex++;
        }

        function realView(camera) {
            //cameraL.position.set(-0.206, -3.89, 5.16);
            var viewPosition = camera.position;
            const near = 1;
            const far = 1000;

            var screenCoordTR = new THREE.Vector3(3.45 * 4, 1.95 * 4, 0 * 4);
            var screenCoordLL = new THREE.Vector3(-3.45 * 4, -1.95 * 4, 0 * 4);
            // var screenCoordUp = new THREE.Vector3(0.535, 0.3025, 0);
            // var screenCoordLow = new THREE.Vector3(-0.535, -0.3025, 0);
            var center = new THREE.Vector3();
            var normal = new THREE.Vector3();
            var projPosition = new THREE.Vector3();
            var look = new THREE.Vector3(viewPosition.x, viewPosition.y, 0)
            const up = new THREE.Vector3(0, 1, 0);

            center.addVectors(screenCoordTR, screenCoordLL).multiplyScalar(0.5);
            normal.subVectors(screenCoordTR, screenCoordLL).cross(up);
            normal.normalize();

            var distance = (new THREE.Vector3).subVectors(viewPosition, center).dot(normal);


            var ratio = near / distance;
            var centerX = ratio * (center.x - look.x);
            var centerY = ratio * (center.y - look.y);
            var halfWidth = 0.5 * ratio * (screenCoordTR.x - screenCoordLL.x);
            var halfHeight = 0.5 * ratio * (screenCoordTR.y - screenCoordLL.y);

            var left = centerX - halfWidth;
            var right = centerX + halfWidth;
            var top = centerY + halfHeight;
            var bottom = centerY - halfHeight;


            console.log('Left: ' + left + ' Right: ' + right + ' Top: ' + top + ' Bottom: ' + bottom);

            camera.projectionMatrix = new THREE.Matrix4().makePerspective(left, right, top, bottom, near, far);
            // camera.projectionMatrix = new THREE.Matrix4().makeOrthographic(left, right, top, bottom, near, far);

            camera.lookAt(look);

            // camera.updateProjectionMatrix();
            camera.updateMatrixWorld(true);
            // camera.matrixAutoUpdate = false;

            return camera;
        }

        //Setting tempo depending on song picked
        function getSongTempo(s) {
            switch (s) {
                case 'roses': tempo = 0.01; break;
                case 'jason_mraz': tempo = 0.005; break;
                case 'korv': tempo = 0.006; break;
                default: tempo = 0.006; break;
            }
            return tempo;
        }

        function sendID() {
            window.location.href = "GUI/GameOver.html?" + totalpoints;
        }

        function initEndingAnimation(totalpoints) {
            document.getElementById('playground').style.animation = "fadeout 4s";
            setTimeout(sendID, 2000);
        }

    </script>
</body>

</html>