<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
<meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>Piano-projector</title>

<!-- Midi.js package -->
<script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
<!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->
<script src = "lib/MIDI.js-master/js/midi/audioDetect.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/gm.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/loader.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/player.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/plugin.audiotag.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/plugin.webaudio.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/plugin.webmidi.js"> </script>
<script src = "lib/MIDI.js-master/js/midi/synesthesia.js"> </script>
<script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>    
<script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
<script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
<script src ="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
<script src ="lib/MIDI.js-master/examples/inc/event.js"></script>
<script src ="lib/MIDI.js-master/examples/inc/timer.js"></script>

<!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->

<!-- Other external libraries -->
<script src = "lib/soundfontplayer.js"> </script>
<script src = "lib/webmidi/src/webmidi.js"> </script>
<script src = "lib/threex.dynamictexture.js"> </script>
<script src="lib\three.js-master\docs\build\three.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
<script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
<script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>
<script src="lib\three.js-master\examples\js\libs\stats.min.js"></script>

<!-- Internal js files -->
<script src = "NoteBlock.js"></script>
<script src = "EventReader.js"></script>
<script src = "Song.js"></script>
<script src = "Clock.js"></script>
<script src = "parseSongData.js"></script>
<script src = "getSongArray.js"></script>
<script src = "keyEffects.js"></script>
<script src = "PointGiver.js"></script>
<script src = "SongResizer.js"></script>
<script src = "Keyboard.js"></script>
<script src = "midi-player.js"></script>


</head>
<body>
<script>


//Global variables
var keyboard = new Keyboard();
var song = new Song(location.search.substring(1).split("?")[0]);
var errorSound = new Audio('./songs-mp3/error.wav');
var noteBlockArray = [];
var blockIndex = 0;
var tempo = getSongTempo(location.search.substring(1).split("?")[0]);
var startTime;
var meshGroup = new THREE.Object3D();
//var fullScoreCounter = 0;
//var starPower = false;


function main(){

    
    //Start keyboard input
    keyboard.startInputOutput(song);

    //Start visualization
    animate();

    //Play picked song
    song.setVolume(0.4);
    //song.playSong();
    startTime = getStartTime();

}

//Creating scene
var scene = new THREE.Scene();
var renderer = new THREE.WebGLRenderer();
renderer.setSize( window.innerWidth, window.innerHeight );
renderer.setClearColor( 0x000000 );
document.body.appendChild( renderer.domElement );

//2D camera
/*
var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
camera.position.z = 10;
*/

//3D camera
cameraLeft = new THREE.PerspectiveCamera( 75, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
cameraLeft.position.set( 0, 0, 10 );
scene.add(cameraLeft);
cameraRight = new THREE.PerspectiveCamera( 75, (window.innerWidth / 2) / window.innerHeight, 1, 4000 );
cameraRight.position.set( 0, 0, 10);
scene.add(cameraRight);
let width = Math.round(window.innerWidth / 2),
    height = window.innerHeight;

var theTime = new Date();
//Loading geometries to scene
loadGeometries();

var theHeight = 2 * Math.tan( ( 75*Math.PI/180 / 2 ) ) * cameraLeft.position.z;

//Creating scoreboard
var dynamicTexture  = new THREEx.DynamicTexture(512,512*2);
dynamicTexture.context.font	= "bolder 200px Verdana";
var scoreGeo = new THREE.BoxGeometry(12, 2, 0.2);
var scoreMat = new THREE.MeshPhongMaterial({ map : dynamicTexture.texture, specular: 10});
var scoreBoard = new THREE.Mesh(scoreGeo, scoreMat);
scoreBoard.position.set(-10,4,0);
//scoreBoard.rotation.y = Math.PI/10;
scene.add(scoreBoard);
dynamicTexture.texture.needsUpdate = true;

//Starting program
main();


function animate(){
    
    let elapsedTime = getCurrentTime() - startTime;

    //if(elapsedTime > noteBlockArray[noteBlockArray.length-1].stopTime /* || points < 0 */ )
    //if(blockIndex == 1)
      //  initEndingAnimation(/*points*/);

    if(blockIndex < noteBlockArray.length) {
       blockpos = Math.tan(75*0.5*(Math.PI/180))*cameraLeft.position.z;

        var lengthToTravel = 2 * blockpos - noteBlockArray[blockIndex].noteLength/2;
        var velocity = tempo * 1000;

    }

    //Adding note blocks to scene (depending on song)
    if(blockIndex < noteBlockArray.length && (Math.abs( elapsedTime - Math.round(noteBlockArray[blockIndex].startTime - 1000*lengthToTravel/velocity))<15)){

        meshGroup.add(noteBlockArray[blockIndex].mesh);
        scene.add(meshGroup);

        noteBlockArray[blockIndex].mesh.position.x = getPositionX(noteBlockArray[blockIndex].note);

        noteBlockArray[blockIndex].mesh.position.y = -meshGroup.position.y + blockpos + noteBlockArray[blockIndex].noteLength/2;

        blockIndex++;
            
    }

    //implementera loop, peka på äldsta noten
   //if(blockIndex < noteBlockArray.length && (getCurrentTime() - startTime) == Math.round(noteBlockArray[blockIndex].stopTime))
       // scene.remove(noteBlockArray[blockIndex].mesh);

    //Translating blocks 
    meshGroup.position.y = - elapsedTime * tempo;
    //cameraLeft.position.y = elapsedTime * tempo;
    //cameraRight.position.y = elapsedTime * tempo;

    //Update score
    dynamicTexture.clear('blue').drawText(getScore(), 150, 200, 'white');
  
    requestAnimationFrame(animate);

    renderer.setViewport( 0, 0, width, height);
    renderer.setScissor( 0, 0, width, height);
    renderer.setScissorTest ( true );
    cameraLeft.aspect = width * 2 / height;
    cameraLeft.updateProjectionMatrix();
    //cameraLeft.position.x = -separation;
    renderer.render( scene, cameraLeft );
    renderer.setViewport( width, 0, width, height);
    renderer.setScissor( width, 0, width, height);
    renderer.setScissorTest ( true );
    cameraRight.aspect = width * 2 / height;
    cameraRight.updateProjectionMatrix();
    //cameraRight.position.x = separation; 
    renderer.render( scene, cameraRight );
   
}

function loadGeometries(){


    var light = new THREE.DirectionalLight( 0xb4e7f2, 5 );
    light.position.set( 5, 5, 5 );
    scene.add( light );

    //Loading note blocks from picked song
    noteBlockArray = loadNoteBlocks();
/*
        for(let i = 0; i < noteBlockArray.length; i++)
        {
                noteBlockArray[i].mesh.position.y = cameraLeft.position.y + (noteBlockArray[i].startTime/1000) * tempo ;

                scene.add(noteBlockArray[i].mesh);

                noteBlockArray[i].mesh.position.x = getPositionX(noteBlockArray[i].note);  

        }
        */

}

/**
* Returning note block x position
*/
function getPositionX(n){

    switch(n){
    case 'C3':  return -0.8; break;
    case 'Db3':  return -0.64; break;
    case 'D3':  return -0.42; break;
    case 'Eb3':  return -0.21; break;
    case 'E3':  return -0.04; break;
    case 'F3':  return 0.27; break;
    case 'Gb3':  return 0.42; break;
    case 'G3':   return 0.65; break;
    case 'Ab3':  return 0.83; break;
    case 'A3':  return 1.03; break;
    case 'Bb3':  return 1.23; break;
    case 'B3':  return 1.39; break;
    case 'C4':  return 1.7;  break;
    case 'Db4':  return 1.85; break;
    case 'D4':  return 2.07; break;
    case 'Eb4':  return 2.27; break;
    case 'E4':  return 2.45; break;
    case 'F4':  return 2.77; break;
    case 'Gb4':  return 2.89; break;
    case 'G4':  return 3.12; break;
    case 'Ab4':  return 3.27; break;
    case 'A4':  return 3.49; break;
    case 'Bb4':  return 3.68; break;
    case 'B4':  return 3.85; break;
    default: return 0;  break;
    }
}

//Setting tempo depending on song picked
function getSongTempo(s){

    switch(s){

        case 'roses': tempo = 0.01; break;
        case 'jason_mraz': tempo = 0.5; break;
        case 'korv': tempo = 0.005; break;

        default: tempo = 0.001; break;
    }

    return tempo;
}

function initEndingAnimation(/*points*/){

    cameraLeft.position.x += 4;
    cameraRight.position.x += 4;
    /*
    //Creating scoreboard
    let tex  = new THREEx.DynamicTexture(1300,720/2);
    tex.context.font	= "bolder 200px Verdana";
    let geo = new THREE.BoxGeometry(35, 7, 2);
    var mat = new THREE.MeshPhongMaterial({ map : tex.texture, specular: 10});
    var boardMesh = new THREE.Mesh(geo, mat);
    boardMesh.position.x = 30;
    scene.add(boardMesh);
    tex.clear('blue').drawText('Game Over', 50, 200, 'white');
    //tex.texture.needsUpdate = true;
*/

    
        //Creating 3D-text
        var loader = new THREE.FontLoader(),
            geometryText,
            materialText,
            textMesh;
            
        loader.load('./lib/three.js-master/examples/fonts/optimer_bold.typeface.json', function (font){

            geometryText = new THREE.TextGeometry( 'Game Over', {
            font: font,
            size: 3,
            height: 1,
            curveSegments: 5,
            bevelThickness: 0.01,
            bevelSize: 0.01,
            bevelSegments: 2,
            bevelEnabled: true,
            });

            materialText = new THREE.MeshPhongMaterial( { color: 0xffffff , specular: 20} );

            textMesh = new THREE.Mesh( geometryText, materialText );
            textMesh.position.set(20, 0, 0);
            scene.add(textMesh);

        });
        

    var loader = new THREE.JSONLoader();

    if(cameraLeft.position.x > 30){
        cameraLeft.position.x = 30;
        cameraRight.position.x = 30;

        scene.remove(scoreBoard);
    }

}


</script>
</body>
</html>