<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
    <meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Piano-projector</title>

    <!-- Midi.js package -->
    <script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->
    <script src="lib/MIDI.js-master/js/midi/audioDetect.js"></script>
    <script src="lib/MIDI.js-master/js/midi/gm.js"></script>
    <script src="lib/MIDI.js-master/js/midi/loader.js"></script>
    <script src="lib/MIDI.js-master/js/midi/player.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.audiotag.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webaudio.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webmidi.js"></script>
    <script src="lib/MIDI.js-master/js/midi/synesthesia.js"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/event.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/timer.js"></script>
    <!--<script src = "lib/MIDI.js-master/build/MIDI.min.js" type="text/javascript"></script>-->

    <!-- Other external libraries -->
    <script src="lib/soundfontplayer.js">

    </script>
    <script src="lib/webmidi/src/webmidi.js">

    </script>
    <script src="lib\three.js-master\docs\build\three.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\EffectComposer.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\MaskPass.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\RenderPass.js"></script>
    <script src="lib\three.js-master\examples\js\shaders\CopyShader.js"></script>
    <script src="lib\three.js-master\examples\js\postprocessing\ShaderPass.js"></script>

    <!-- Internal js files -->
    <script src="NoteBlock.js"></script>
    <script src="EventReader.js"></script>
    <script src="Song.js"></script>
    <script src="Clock.js"></script>
    <script src="parseSongData.js"></script>
    <script src="getSongArray.js"></script>
    <script src="keyEffects.js"></script>
    <script src="PointGiver.js"></script>
    <script src="SongResizer.js"></script>
    <script src="Keyboard.js"></script>
    <script src="midi-player.js"></script>

</head>

<body>
    <script>
        //Global variables
        var keyboard = new Keyboard();
        var song = new Song(location.search.substring(1).split("?")[0]);
        var errorSound = new Audio('./songs-mp3/error.wav');
        var noteBlockArray = [];
        var blockIndex = 0;
        var tempo = getSongTempo(location.search.substring(1).split("?")[0]);
        //var fullScoreCounter = 0;
        //var starPower = false;


        function main() {

            //Start keyboard input
            keyboard.startInputOutput(song);

            //Start visualization
            animate();

            //Play picked song
            song.setVolume(0.4);
            song.playSong();
            startClock();

        }

        //Creating scene
        var scene = new THREE.Scene();
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0xfaf0e6);
        document.body.appendChild(renderer.domElement);

/*        //Create black line at bottom of scene
        var geometry = new THREE.BoxGeometry(4.5, 0.05, 0.2);
        var material = new THREE.MeshPhongMaterial({ color: 0x050505, transparent: true, opacity: 0.8});
        var material2 = new THREE.MeshPhongMaterial({ color: 0xff0000, transparent: true, opacity: 0.8 });
        // var material3 = new THREE.MeshPhongMaterial({ color: 0xff0000, wireframe: true});
        var line = new THREE.Mesh(geometry, material);
        scene.add(line);*/

/*        var line2 = line.clone();
        line2.material = material3;
        line2.material.needsUpdate = true;
        scene.add(line2);*/

/*        //Create test box
        var geometry = new THREE.BoxGeometry(2, 2, 2);
        var material = new THREE.MeshPhongMaterial({color: 0xff0000, wireframe: true});
        var box = new THREE.Mesh(geometry, material);
        
         scene.add(box);*/

/*        var axisHelper = new THREE.AxisHelper(3);
        
        line.add(axisHelper);*/

        //2D camera
        /*
        var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
        camera.position.z = 10;*/

/*        //Implement 3D camera
        //Top 3D camera 
        //Left perspective camera
        cameraLeft = new THREE.PerspectiveCamera(45, (window.innerWidth/2)/ window.innerHeight, 1, 4000);
        cameraLeft.position.set(0, 0, 10);
        scene.add(cameraLeft);
        
        //Right perspective camera
        cameraRight = new THREE.PerspectiveCamera(45, (window.innerWidth/2)/ window.innerHeight, 1, 4000);
        cameraRight.position.set(0, 0, 10);
        scene.add(cameraRight);
        var width = Math.round(window.innerWidth/2),
            height = window.innerHeight;*/
        
        //Implement 3D camera
        //Correct frustum eye 3D camera 
        //Left perspective camera
        // cameraLeft = new THREE.PerspectiveCamera(30.07, 0.88875, 1, 4000);
        cameraLeft = new THREE.PerspectiveCamera(30.07, (window.innerWidth/2)/ window.innerHeight, 1, 4000);
        cameraLeft.position.set(-0.08, -3.89, 5.15);//separation -0.043
        cameraLeft.lookAt(scene.position);
        scene.add(cameraLeft);
        
        //Right perspective camera
        // cameraRight = new THREE.PerspectiveCamera(30.07, 0.88875, 1, 4000);
        cameraRight = new THREE.PerspectiveCamera(30.07, (window.innerWidth/2)/ window.innerHeight, 1, 4000);
        cameraRight.position.set(0.08, -3.89, 5.15);//separation 0.043
        cameraRight.lookAt(scene.position);
        scene.add(cameraRight);
        var width = Math.round(window.innerWidth/2),
            height = window.innerHeight;
        
        
        //Loading geometries to scene
        loadGeometries();
       
        //Starting program
        main();

        function animate() {
            if (blockIndex < noteBlockArray.length) {
                blockpos = Math.tan(75 * 0.5 * (Math.PI / 180)) * scene.position.z + noteBlockArray[blockIndex].noteLength / 2;
            }

            //Adding note blocks to scene (depending on song)
            if (blockIndex < noteBlockArray.length && getClockTime() ==
                Math.round(noteBlockArray[blockIndex].startTime - (10 * blockpos / (tempo * 60)))) {

                scene.add(noteBlockArray[blockIndex].mesh);
                noteBlockArray[blockIndex].mesh.position.x = getPositionX(noteBlockArray[blockIndex].note);

                noteBlockArray[blockIndex].mesh.position.y = scene.position.y + blockpos / 2;

                blockIndex++;
            }

            //Translating blocks (camera)
            // cameraLeft.position.y += tempo;
            // cameraRight.position.y += tempo;

            // line.position.y = (scene.position.y)-1.7;
            // line2.position.y = (scene.position.y)-1.7;

            // box.position.set(0, 0, 0);

            requestAnimationFrame(animate);

            //Render 3D camera
            //Render left camera
            renderer.setViewport(0, 0, width, height);
            renderer.setScissor(0, 0, width, height);
            renderer.setScissorTest(true);
            cameraLeft.aspect = width * 2 / height;
            cameraLeft.updateProjectionMatrix();
            renderer.render(scene, cameraLeft);

            //Render right camera
            renderer.setViewport(width, 0, width, height);
            renderer.setScissor(width, 0, width, height);
            renderer.setScissorTest(true);
            cameraRight.aspect = width * 2 / height;
            cameraRight.updateProjectionMatrix();
            renderer.render(scene, cameraRight);

            //Render 2D camera
            // renderer.render(scene, camera);
        }

        function loadGeometries() {
            var light = new THREE.DirectionalLight(0xb4e7f2, 5);
            light.position.set(5, 5, 5);
            scene.add(light);

            //Loading note blocks from picked song
            noteBlockArray = loadNoteBlocks();
        }

        /**
        * Returning note block x position
        */
        function getPositionX(n) {

            switch (n) {
                case 'C3': return -0.8; break;
                case 'Db3': return -0.64; break;
                case 'D3': return -0.42; break;
                case 'Eb3': return -0.21; break;
                case 'E3': return -0.04; break;
                case 'F3': return 0.27; break;
                case 'Gb3': return 0.42; break;
                case 'G3': return 0.65; break;
                case 'Ab3': return 0.83; break;
                case 'A3': return 1.03; break;
                case 'Bb3': return 1.23; break;
                case 'B3': return 1.39; break;
                case 'C4': return 1.7; break;
                case 'Db4': return 1.85; break;
                case 'D4': return 2.07; break;
                case 'Eb4': return 2.27; break;
                case 'E4': return 2.45; break;
                case 'F4': return 2.77; break;
                case 'Gb4': return 2.89; break;
                case 'G4': return 3.12; break;
                case 'Ab4': return 3.27; break;
                case 'A4': return 3.49; break;
                case 'Bb4': return 3.68; break;
                case 'B4': return 3.85; break;
                default: return 0; break;
            }
        }

        //Setting tempo depending on song picked
        function getSongTempo(s) {

            switch (s) {

                case 'roses': tempo = 0.035; break;
                case 'jason_mraz': tempo = 0.2; break;
                case 'korv': tempo = 0.2; break;

                default: tempo = 0.001; break;
            }

            return tempo;
        }
    </script>
</body>

</html>