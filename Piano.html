<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="GUI/stylesheet.css" type="text/css" media="screen">
    <meta name="viewport" charset="UTF-8" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Piano-projector</title>

    <!-- Midi.js package -->
    <script src="lib/MIDI.js-master/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/build/MIDI.min.js"></script>
    <script src="lib/MIDI.js-master/js/midi/audioDetect.js"></script>
    <script src="lib/MIDI.js-master/js/midi/gm.js"></script>
    <script src="lib/MIDI.js-master/js/midi/loader.js"></script>
    <script src="lib/MIDI.js-master/js/midi/player.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.audiotag.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webaudio.js"></script>
    <script src="lib/MIDI.js-master/js/midi/plugin.webmidi.js"></script>
    <script src="lib/MIDI.js-master/js/midi/synesthesia.js"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/midifile.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/replayer.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/inc/jasmid/stream.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="lib/MIDI.js-master/examples/inc/colorspace.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/event.js"></script>
    <script src="lib/MIDI.js-master/examples/inc/timer.js"></script>
    <script src="lib/MIDI.js-master/build/MIDI.min.js"></script>

    <!-- Other external libraries -->
    <script src="lib/soundfontplayer.js">

    </script>
    <script src="lib/webmidi/src/webmidi.js">

    </script>
    <script src="lib\three.js-master\docs\build\three.js"></script>

    <!-- Internal js files -->
    <script src="NoteBlock.js"></script>
    <script src="EventReader.js"></script>
    <script src="Song.js"></script>
    <script src="Clock.js"></script>
    <script src="parseSongData.js"></script>
    <script src="getSongArray.js"></script>
    <script src="keyEffects.js"></script>
    <script src="PointGiver.js"></script>
    <script src="SongResizer.js"></script>
    <script src="Keyboard.js"></script>
    <script src="midi-player.js"></script>


</head>

<body>
    <script>
        //Global variables
        var keyboard = new Keyboard();
        var song = new Song(location.search.substring(1).split("?")[0]);
        var errorSound = new Audio('./songs-mp3/error.wav');
        var noteBlockArray = [];
        var blockIndex = 0;
        var tempo = getSongTempo(song.getSongName());
        //var fullScoreCounter = 0;
        //var starPower = false;
        var glowTime = 35;

        function main() {

            //Start keyboard input
            keyboard.startInputOutput(song);

            //Start visualization
            animate();

            //Play picked song
            song.setVolume(0.4);
            song.playSong();
            startClock();

        }

        //Creating scene
        var scene = new THREE.Scene();
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0xfaf0e6);
        document.body.appendChild(renderer.domElement);

        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 10;

        //Create black line at bottom of scene
        var geometry = new THREE.BoxGeometry(40.2, 0.5, 2);
        var material = new THREE.MeshPhongMaterial({color: 0x050505, transparent: true, opacity: 0.9});
        var material2 = new THREE.MeshPhongMaterial({color: 0xff0000, transparent: true, opacity: 0.8});
        var line = new THREE.Mesh(geometry, material);
        scene.add(line);

        //Loading geometries to scene
        loadGeometries();

        //Starting program
        main();


        function animate() {

            //Adding note blocks to scene (depending on song)
            if (blockIndex < noteBlockArray.length && getClockTime() == noteBlockArray[blockIndex].startTime) {

                scene.add(noteBlockArray[blockIndex].mesh);
                noteBlockArray[blockIndex].mesh.position.x = getPositionX(noteBlockArray[blockIndex].note);
                noteBlockArray[blockIndex].mesh.position.y = camera.position.y + 9;
                blockIndex++;
            }

            //Translating blocks 
            camera.position.y += tempo;
            line.position.y = camera.position.y - 7.5;

            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function loadGeometries() {

            var light = new THREE.DirectionalLight(0xb4e7f2, 5);
            light.position.set(5, 5, 5);
            scene.add(light);

            //Loading note blocks from picked song
            noteBlockArray = loadNoteBlocks();

        }

        /**
        * Returning note block x position
        */
        function getPositionX(n) {

            let res = 0;

            switch (n) {
                case 'C3': res = -12; break;
                case 'Db3': res = -11; break;
                case 'D3': res = -10; break;
                case 'Eb3': res = -9; break;
                case 'E3': res = -8; break;
                case 'F3': res = -6; break;
                case 'Gb3': res = -5; break;
                case 'G3': res = -4; break;
                case 'Ab3': res = -3; break;
                case 'A3': res = -2; break;
                case 'Bb3': res = -1; break;
                case 'B3': res = 0; break;
                case 'C4': res = 2; break;
                case 'Db4': res = 3; break;
                case 'D4': res = 4; break;
                case 'Eb4': res = 5; break;
                case 'E4': res = 6; break;
                case 'F4': res = 8; break;
                case 'Gb4': res = 9; break;
                case 'G4': res = 10; break;
                case 'Ab4': res = 11; break;
                case 'A4': res = 12; break;
                case 'Bb4': res = 13; break;
                case 'B4': res = 14; break;
                default: res = 0; break;
            }

            return res;
        }

        //Setting tempo depending on song picked
        function getSongTempo(s) {

            switch (s) {

                case 'roses': tempo = 0.035; break;
                case 'jason_mraz': tempo = 0.12; break;
                default: tempo = 0.001; break;
            }

            return tempo;
        }
    </script>
</body>

</html>